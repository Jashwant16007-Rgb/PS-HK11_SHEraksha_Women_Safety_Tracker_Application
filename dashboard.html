<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title> AegisHER - Police Control Room </title>

    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">
    <!-- Supabase SDK -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Poppins', sans-serif; }
        body { background: radial-gradient(circle at 20% 30%, #1f1f2e, #0f0f0f 60%); color: white; min-height: 100vh; overflow-x: hidden; }

        .navbar { position: sticky; top: 0; display: flex; justify-content: space-between; align-items: center; padding: 15px 30px; background: rgba(255, 255, 255, 0.08); backdrop-filter: blur(20px); border-bottom: 1px solid rgba(255, 255, 255, 0.1); z-index: 1000; }
        .logo { font-weight: 700; color: #ff4d4d; }
        .live-indicator { color: #ff4d4d; animation: blink 1s infinite; font-weight: bold; }
        @keyframes blink { 50% { opacity: 0.3; } }

        .header { text-align: center; padding: 20px; font-size: 28px; font-weight: 700; background: linear-gradient(90deg, #ff4d4d, #ff0080); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }

        .container { display: grid; grid-template-columns: 1fr 2.5fr; gap: 20px; padding: 20px; height: calc(100vh - 150px); }
        @media(max-width:1200px) { .container { grid-template-columns: 1fr; height: auto; } }

        .card { background: rgba(255, 255, 255, 0.08); backdrop-filter: blur(20px); border-radius: 15px; padding: 20px; box-shadow: 0 10px 30px rgba(0, 0, 0, 0.4); height: 100%; border: 1px solid rgba(255, 255, 255, 0.05); display: flex; flex-direction: column; }
        h3 { margin-bottom: 15px; color: #ff4d4d; border-bottom: 1px solid rgba(255, 255, 255, 0.1); padding-bottom: 10px; }

        .incident-list { flex: 1; overflow-y: auto; }
        .incident { padding: 15px; margin-bottom: 12px; border-radius: 10px; background: rgba(255, 255, 255, 0.07); cursor: pointer; transition: 0.3s; border-left: 5px solid transparent; }
        .incident:hover { background: rgba(255, 255, 255, 0.15); transform: translateX(5px); }
        .incident.active-select { background: rgba(255, 77, 77, 0.2); border-color: #ff4d4d; }
        .critical { border-left-color: #ff4d4d; }
        .dispatched { border-left-color: #4cd964; }

        .status-badge { display: inline-block; padding: 5px 12px; border-radius: 20px; font-size: 12px; font-weight: 600; background: #ff4d4d; color: white; margin-bottom: 10px; }
        .status-badge.green { background: #4cd964; }

        .details-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-top: 15px; }
        .details-box { background: rgba(255, 255, 255, 0.05); padding: 12px; border-radius: 10px; border: 1px solid rgba(255, 255, 255, 0.05); }
        .details-box b { color: #aaa; font-size: 11px; text-transform: uppercase; }
        .details-box p { font-size: 15px; margin-top: 4px; font-weight: 600; }

        .timeline { margin-top: 25px; padding-top: 15px; border-top: 1px solid rgba(255, 255, 255, 0.1); overflow-y: auto; max-height: 150px; }
        .timeline-item { font-size: 13px; margin-bottom: 10px; padding-left: 15px; border-left: 2px solid #ff4d4d; position: relative; }

        .action-buttons { margin-top: 20px; display: flex; gap: 10px; }
        .action-buttons button { flex: 1; padding: 12px; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; background: linear-gradient(135deg, #ff4d4d, #ff0080); color: white; transition: 0.3s; display: flex; align-items: center; justify-content: center; gap: 8px; }
        .action-buttons button:hover { opacity: 0.8; transform: translateY(-2px); }
        .action-buttons button.secondary { background: linear-gradient(135deg, #444, #222); }
        .no-data { text-align: center; opacity: 0.5; padding: 40px; }
    </style>
</head>

<body>
    <div class="navbar">
        <div class="logo">AegisHER PCR Dashboard</div>
        <div class="live-indicator">‚óè LIVE CONNECTION</div>
        <div id="clock"></div>
    </div>

    <div class="header">
        üö® Real-Time Emergency Monitoring
    </div>

    <div class="container">
        <!-- LEFT PANEL -->
        <div class="card">
            <h3>Active Alerts</h3>
            <div id="incidentList" class="incident-list">
                <div class="no-data">Waiting for alerts...</div>
            </div>
        </div>

        <!-- CENTER PANEL -->
        <div class="card" id="detailsCard">
            <h3>Incident Information</h3>
            <div id="detailsContent" style="flex:1">
                <div class="no-data">Select an incident to view details</div>
            </div>
        </div>
    </div>

    <script>
        const SUPABASE_URL = "YOUR_SUPABASE_URL";
        const SUPABASE_KEY = "YOUR_SUPABASE_KEY";


        const _supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        let incidents = [];
        let selectedId = null;

        fetchAlerts();

        async function fetchAlerts() {
            const { data } = await _supabase.from('sos_alerts').select('*').order('last_update', { ascending: false });
            if (data) {
                incidents = data;
                renderList();
            }
        }

        _supabase.channel('sos-pcr').on('postgres_changes', { event: '*', schema: 'public', table: 'sos_alerts' }, fetchAlerts).subscribe();

        function renderList() {
            const listDiv = document.getElementById('incidentList');
            listDiv.innerHTML = '';
            if (incidents.length === 0) {
                listDiv.innerHTML = '<div class="no-data">Waiting for alerts...</div>';
                return;
            }
            incidents.forEach(item => {
                const isDispatched = item.event === 'POLICE_DISPATCHED';
                const div = document.createElement('div');
                div.className = `incident ${isDispatched ? 'dispatched' : 'critical'} ${selectedId === item.session_id ? 'active-select' : ''}`;
                div.innerHTML = `<b>${item.session_id}</b><br><small>${new Date(item.last_update).toLocaleTimeString()}</small><br><small style="color:#ff9999">${item.alert_type}</small>`;
                div.onclick = () => selectIncident(item);
                listDiv.appendChild(div);
            });
        }

        function selectIncident(item) {
            selectedId = item.session_id;
            renderList();
            renderDetails(item);
        }

        function renderDetails(item) {
            const isDispatched = item.event === 'POLICE_DISPATCHED';
            const { data: photoData } = _supabase.storage.from('evidence').getPublicUrl(`${item.session_id}/initial_photo.jpg`);
            const { data: audioData } = _supabase.storage.from('evidence').getPublicUrl(`${item.session_id}/initial_audio.mp3`);
            const photoUrl = photoData.publicUrl;
            const audioUrl = audioData.publicUrl;

            document.getElementById('detailsContent').innerHTML = `
                <span class="status-badge ${isDispatched ? 'green' : ''}">${isDispatched ? 'DISPATCHED' : 'CRITICAL'}</span>
                <div class="details-grid">
                    <div class="details-box"><b>Victim Name</b><p>${item.victim_name || 'N/A'}</p></div>
                    <div class="details-box"><b>Contact</b><p>${item.victim_mobile || 'N/A'}</p></div>
                    <div class="details-box"><b>Alert Type</b><p>${item.alert_type}</p></div>
                    <div class="details-box"><b>Coordinates</b><p>${item.latitude?.toFixed(4)}, ${item.longitude?.toFixed(4)}</p></div>
                </div>
                <div class="action-buttons">
                    <button class="secondary" onclick="window.open('tel:${item.victim_mobile}')">üìû Call Victim</button>
                    <button onclick="dispatchUnit('${item.session_id}')">üöì Dispatch Unit</button>
                </div>
                <div class="action-buttons">
                    <button class="secondary" onclick="window.open('${photoUrl}', '_blank')">üì∑ View Photo</button>
                    <button class="secondary" onclick="window.open('${audioUrl}', '_blank')">üîä View Audio</button>
                </div>
                <div class="action-buttons">
                    <button onclick="window.open('https://www.google.com/maps?q=${item.latitude},${item.longitude}', '_blank')">üó∫Ô∏è Go to Map</button>
                </div>
            `;
        }

        window.dispatchUnit = async (id) => {
            await _supabase.from('sos_alerts').update({ event: 'POLICE_DISPATCHED' }).eq('session_id', id);
            alert("Unit Dispatched!");
        };

        function updateClock() { document.getElementById("clock").innerText = new Date().toLocaleTimeString(); }
        setInterval(updateClock, 1000); updateClock();
    </script>
</body>
</html>
